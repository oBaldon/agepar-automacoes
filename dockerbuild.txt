#!/usr/bin/env bash
set -euo pipefail

# =========[ 0) Vars ]=========
ROOT="$PWD"
DATA="$ROOT/apps/validador-orcamento/worker/data"
OUT="$ROOT/apps/validador-orcamento/worker/output"
API="http://localhost:8001"

# =========[ 1) Network ]=========
docker network ls | grep -q 'agepar-automacoes_default' || \
  docker network create agepar-automacoes_default

# =========[ 2) Redis ]=========
docker rm -f redis 2>/dev/null || true
docker run -d --name redis --restart unless-stopped \
  --network agepar-automacoes_default \
  -p 6379:6379 \
  redis:7-alpine

# =========[ 3) Worker ]=========
cd "$ROOT/apps/validador-orcamento/worker"
docker build -t agepar/validador-worker:dev .
docker rm -f validador-worker 2>/dev/null || true
docker run -d --name validador-worker --restart unless-stopped \
  --network agepar-automacoes_default \
  -e REDIS_URL="redis://redis:6379/1" \
  -e QUEUE_NAME="validador" \
  -v "$DATA:/app/data:ro" \
  -v "$OUT:/app/output" \
  -u $(id -u):$(id -g) \
  agepar/validador-worker:dev

# =========[ 4) API ]=========
cd "$ROOT/apps/validador-orcamento/api"
docker build -t agepar/validador-api:dev .
docker rm -f validador-api 2>/dev/null || true
docker run -d --name validador-api --restart unless-stopped \
  --network agepar-automacoes_default \
  -p 8001:8000 \
  -e REDIS_URL="redis://redis:6379/1" \
  -e QUEUE_NAME="validador" \
  -e CORS_ORIGINS="http://10.59.1.81:5173,http://192.168.18.187:5173,http://localhost:5173" \
  -v "$OUT:/app/output:ro" \
  agepar/validador-api:dev

# =========[ 5) Health ]=========
curl -s "$API/health" | jq .
docker exec -it validador-api getent hosts redis || true

# =========[ 6) Fluxo JOBS ]=========

# ---- PREÇOS ----
JOB_ID=$(
curl -s "$API/jobs" \
  -H 'content-type: application/json' \
  -d "{
    \"op\": \"precos_auto\",
    \"orc\": \"data/orcamento2.xlsx\",
    \"sudecap\": \"data/sudecap_preco.xls\",
    \"sinapi\": \"data/sinapi_ccd.xlsx\",
    \"secid\": \"data/secid.xlsx\",
    \"tol_rel\": 0,
    \"comparar_desc\": true,
    \"out_dir\": \"output\"
  }" | jq -r .id
)
echo "Job (preços): $JOB_ID"

# Status
curl -s "$API/jobs/$JOB_ID" | jq .

# Resultado (corrigido: remove '}' extra)
curl -s "$API/jobs/$JOB_ID/result" | jq .

# ---- ESTRUTURA (opcional) ----
JOB2_ID=$(
curl -s "$API/jobs" \
  -H 'content-type: application/json' \
  -d "{
    \"op\": \"estrutura_auto\",
    \"orc\": \"data/orcamento2.xlsx\",
    \"sudecap\": \"data/sudecap_comp.xls\",
    \"sinapi\": \"data/sinapi_ccd.xlsx\",
    \"secid\": \"data/secid.xlsx\",
    \"out_dir\": \"output\"
  }" | jq -r .id
)
echo "Job (estrutura): $JOB2_ID"

curl -s "$API/jobs/$JOB2_ID" | jq .
curl -s "$API/jobs/$JOB2_ID/result" | jq .
